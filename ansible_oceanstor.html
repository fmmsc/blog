<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>FMM · Blog</title>
    
    <meta name="description" content="N.Agency - Responisve Landing Page for Agency">
    <meta name="keywords" content="">
    <meta name="author" content="tabthemes">
    
    <!-- Favicons -->
    <link rel="shortcut icon" href="img/favicon.png">
    <link rel="apple-touch-icon" sizes="57x57" href="img/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="72x72" href="img/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="img/apple-touch-icon-114x114.png">
    
    <!-- Google Web Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- CSS Files For Plugin -->
    <link href="css/animate.css" rel="stylesheet">
    <link href="css/font-awesome/font-awesome.min.css" rel="stylesheet">
    <link href="css/magnific-popup.css" rel="stylesheet" />
    <link href="css/YTPlayer.css" rel="stylesheet" />
    <link rel="stylesheet" href="inc/owlcarousel/css/owl.carousel.min.css">
    <link rel="stylesheet" href="inc/owlcarousel/css/owl.theme.default.min.css">
    <link rel="stylesheet" href="inc/revolution/css/settings.css" />
    <link rel="stylesheet" href="inc/revolution/css/layers.css" />
    <link rel="stylesheet" href="inc/revolution/css/navigation.css" />
    
    <!-- Custom CSS -->
    <link href="css/style.css" rel="stylesheet">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body class="single_post_page_full" data-spy="scroll" data-target=".navbar-fixed-top" data-offset="100">
    
    
    <!-- Preloader -->
    <div id="preloader">
        <div id="spinner"></div>
    </div>
    <!-- End Preloader-->

    
    <!-- Start Navigation -->
    <header class="nav-solid" id="home">

        <nav class="navbar navbar-fixed-top">
            <div class="navigation">
                <div class="container-fluid site-footer">
                    <div class="row">

                        <div class="navbar-header">
                            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                                <span class="sr-only">Toggle navigation</span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                            </button>

                            <!-- Logo -->
                            <div class="logo-container">
                                <div class="logo-wrap local-scroll">
                                  <a href="index.html">
                                    <img class="logo" style="width: 50%;" src="img/logo_light.png" alt="logo" data-rjs="2">
                                  </a>
                                </div>
                            </div>
                        </div> <!-- end navbar-header -->

                        <div class="col-md-8 col-xs-12 nav-wrap">
                            <div class="collapse navbar-collapse" id="navbar-collapse">
				<ul class="nav navbar-nav navbar-right">
                                    <li><a href="https://www.fmmsc.com/index.html">Home</a></li>
                                    <li><a href="https://www.fmmsc.com/index.html#services">Services</a></li>
                                    <li><a href="https://www.fmmsc.com/index.html#solutions">Solutions</a></li>
                                    <li><a href="index.html">Blog</a></li>
                                    <li><a href="https://www.fmmsc.com/index.html#about">About</a></li>
                                    <li><a href="https://www.fmmsc.com/index.html#contact">Contact</a></li>
                                </ul>

                            </div>
                        </div> <!-- /.col -->

                    </div> <!-- /.row -->
                </div> <!--/.container -->
            </div> <!-- /.navigation-overlay -->
        </nav> <!-- /.navbar -->

    </header>
    <!-- End Navigation -->

    
    <!--BLog single section-->
    <section id="blog-single" class="p-top-80 p-bottom-80">

        <!--Container-->
        <div class="container clearfix">

            <div class="row">

                <div class="col-xs-12">
                    
                    <!--Post Single-->
                    <div class="postSingle">               

                        <div class="postTitle" style="text-align: center;">
                            <h1>Huawei OceanStor API Automation</h1>
                            <div class="divider-center-small"></div>
                        </div> <!--Post title-->  

                        <p>If you are looking to automate some tasks in your Huawei OceanStor instead of doing manual work, the API provided by Huawei for the software can be a simple solution for your needs that requires no setup or configuration. In this case, we will be using <b>ansible</b> to automate the process and the calls, so we will need that package installed. The used ansible core version in this example is the 2.14.<br>
                        The OceanStor API documentation can be quite extensive, so we will let here just a couple of examples of usage, that hopefully will help you understand and maybe save some time. For any other needs check out the official documentation and feel free to build on top of this template.</p>
                            
                         <blockquote>"Work smarter, not harder."</blockquote>
                                    
                        <p>This ansible playbook can be ran from your local machine or from a remote server, depending on your environment, as long as the ansible packages are installed and present. The playbook as is, will run locally, connect to the Huawei OceanStor API on the default port <b>8088</b> and authenticate the user. In this example, we will backup a volume using the snapshot and clone method, first getting all the available volumes, after creating the clone and the snapshot for the selected one.<br><br><b>NOTE</b>: It's possible to skip the authentication by removing the first task and getting the values from the <b>login</b> variable to the headers in the later tasks.</p>

                            <pre><code class="ansible">---
- hosts: localhost # Host with network flow to the Huawei OceanStor API
  gather_facts: no 
  vars:
    time: "{{ ansible_date_time.epoch_int }}"
    source_lun: lun_name # LUN to operate on
    ip: 10.0.0.10 # Huawei OceanStor API address
    port: 8088 # Huawei OceanStor API port
    username: admin
    password: ''
    scope: 0 # Scope 0 is for local users, 1 is for LDAP
  tasks:
    - name: API Login
      uri:
        url: "https://{{ ip }}:{{ port }}/deviceManager/rest/xxxxx/sessions"
        method: POST
        body_format: json
        body: 
          username: "{{ username }}"
          password: "{{ password }}"
          scope: "{{ scope }}"
        timeout: 10
        validate_certs: no
      register: login # Will return the variables for headers later use for the authenticated user

    - debug:
        var: login

    - name: Get LUNs
      uri:
        url: "https://{{ ip }}:{{ port }}/deviceManager/rest/{{ login.json.data.deviceid }}/lun"
        method: GET
        timeout: 5
        validate_certs: no
        headers:
         Content-Type: "{{ login.content_type }}"
         iBaseToken: "{{ login.json.data.iBaseToken }}"
         Cookie: "{{ login.set_cookie }}"
      register: unmap # returns a list of LUNs

    - debug:
        var: unmap.json.data

    - name: Clone LUN {{ source_lun }}
      uri:
        url: "https://{{ ip }}:{{ port }}/deviceManager/rest/{{ login.json.data.deviceid }}/lun"
        method: POST
        body_format: json
        body: 
          isclone: true
          name: "dstore_{{ time }}_{{ mysql_instance }}"
          clonesourceid: '{{ unmap.somevalue }}'
        timeout: 5
        validate_certs: no
        headers:
         Content-Type: "{{ login.content_type }}"
         iBaseToken: "{{ login.json.data.iBaseToken }}"
         Cookie: "{{ login.set_cookie }}"
      register: cloned

    - name: Mapping LUN {{ cloned.json.instanceId }}
      uri:
        url: "https://{{ ip }}:{{ port }}/api/v2/mapping"
        method: POST
        body_format: json
        body: '{ "lunId": "", "hostName": "{{ Server }}" }' # Can be used lunName instead
        timeout: 5
        validate_certs: no
        headers:
         Content-Type: "{{ login.content_type }}"
         iBaseToken: "{{ login.json.data.iBaseToken }}"
         Cookie: "{{ login.set_cookie }}"
      register: mapped
      when:  cloned.json | length >= 1
</code></pre>
                        <p>To run the playbook simply execute the following line in the terminal:
                        <pre><code class="bash">ansible-playbook /path/to/created_playbook.yml</code></pre>
                        
                        <p><b>Disclaimer:</b> This playbook should be used as an example only and should not be used directly in production environments, since there can be quite the differences between software configurations that can result in misconfigurations or worse incidents like data loss. Consult with a specialist and test the play before in some sort of development environment. Reach out if any support or development is needed.</p>
                     
                        <div class="postTags clearfix">
                            <h4><i class="fa fa-tags"></i>Tags :</h4>
                            <ul class="list-inline">
                                <li><a href="#">Ansible</a></li>
                            </ul>
                        </div>

                    </div>
                    <!--End post single-->            
                </div>
            </div> <!-- /.row -->
        
        </div> <!-- /.container -->

    </section><!--End blog single section-->

    <!-- Start Footer -->
    <footer class="site-footer">
        <div class="container">
            <small class="copyright pull-left">Copyrights © 2022 All rights reserved by <a href="https://www.fmmsc.com/">FMM Consulting</a></small>
            <div class="social-icon pull-right">
                <a href="https://www.facebook.com/fmmosc"><i class="fa fa-facebook"></i></a>
                <a href="https://www.twitter.com/fmmosc"><i class="fa fa-twitter"></i></a>
                <a href="https://www.linkedin.com/company/fmmsc"><i class="fa fa-linkedin"></i></a>
                <a href="https://www.instagram.com/fmmossc"><i class="fa fa-instagram"></i></a>
                <a href="https://github.com/fmmsc"><i class="fa fa-github"></i></a>
                <a href="https://music.fmmsc.com"><i class="fa fa-play-circle"></i></a>
                <a href="https://blog.fmmsc.com"><i class="fa fa-comments-o"></i></a>
            </div>
            <!-- /social-icon -->
        </div>
        <!-- /container -->
    </footer>
    <!-- End Footer -->

    <!-- Back to top -->
    <a href="#" id="back-to-top" title="Back to top"><i class="fa fa-angle-up"></i></a>
    <!-- /Back to top -->

    
    <!-- jQuery -->
    <script src="js/jquery.min.js"></script>
    
    <!-- Bootstrap -->
    <script src="bootstrap/js/bootstrap.min.js"></script>
    
    <!-- Components Plugin -->
    <script src="js/jquery.easing.1.3.js"></script>
    <script src="js/smooth-scroll.js"></script>
    <script src="js/jquery.appear.js"></script>
    <script src="js/jquery.countTo.js"></script>
    <script src="js/jquery.stellar.min.js"></script>
    <script src="js/jquery.magnific-popup.min.js"></script>
    <script src="js/imagesloaded.pkgd.min.js"></script>
    <script src="js/isotope.pkgd.min.js"></script>
    <script src="js/jquery.mb.YTPlayer.js"></script>
    <!-- <script src="js/retina.min.js"></script> -->
    <script src="js/wow.min.js"></script>
    <script src="inc/owlcarousel/js/owl.carousel.min.js"></script>
    
    <!-- Custom Plugin -->
    <script src="js/custom.js"></script>
    
  </body>
</html>
